(r=>{let e={config:{buttonClass:"ai-generate-btn",buttonVoice:"ai-voice-btn",wrapperClass:"ai-textarea-wrapper",activeClass:"ai-active",loadingClass:"ai-loading",modalClass:"ai-generator-modal",apiEndpoint:"/api/ai/generate",apiMethod:"POST",apiHeaders:{},defaultMaxTokens:200,defaultTemperature:.7,closeOnOutsideClick:!1,zIndexBase:1050,zIndexIncrement:10,zIndexMax:9999,modalParentAttribute:"data-ai-parent-modal",prefill:{enabled:!0,maxLength:500,append:!1},i18n:{title:"AI Content Generator",generate:"Generate",generating:"Generating...",insert:"Insert",cancel:"Cancel",promptLabel:"Prompt",promptPlaceholder:"Describe what you want to generate...",maxLengthLabel:"Max Length",creativityLabel:"Creativity",resultLabel:"Generated Content",errorMessage:"Failed to generate content. Please try again.",loadingText:"Generating content...",back:"Back to prompt",responseLabel:"Response",responseHtml:"HTML",responseMarkdown:"Markdown",responseText:"Text",generateVoice:"Speak to content"},styles:{modal:{maxWidth:"600px",width:"90%"},button:{size:"32px",iconSize:"16px"}}},instances:new Map,recognition:null,isListening:!1,init:function(t){this.config=r.extend(!0,{},this.config,t),r(document).on("click","."+this.config.buttonClass,this.handleButtonClick.bind(this)),r(document).on("click","."+this.config.buttonVoice,this.handleVoiceButtonClick.bind(this)),this.scanTextareas(),this.setupMutationObserver()},scanTextareas:function(){r("textarea[data-ai-generate]").each((t,e)=>{this.attachAIButton(r(e))})},attachAIButton:function(a){if(!a.parent().hasClass(this.config.wrapperClass)){a.wrap(`<div class="${this.config.wrapperClass} position-relative"></div>`);var n=a.parent();let t=1;"true"===a.attr("data-ai-voice")&&(this.initSpeechRecognition(),t++);var o=(parseInt(this.config.styles.button.size)+4)*t,s=parseInt(a.css("padding-right"))||0;a.css("padding-right",s+o+"px");let e=4;if("true"===a.attr("data-ai-voice")){let t=r(`
                    <button type="button" 
                        class="${this.config.buttonVoice}" 
                        title="${this.config.i18n.generateVoice||"Generate Voice"}"
                        data-target-id="${a.attr("id")}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
                            <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"/>
                            <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3"/>
                        </svg>
                    </button>
                `);t.css({position:"absolute",bottom:"8px",right:e+"px",border:"none",borderRadius:"4px",width:this.config.styles.button.size,height:this.config.styles.button.size,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",padding:"0",color:"#64748b",transition:"all 0.2s ease",backgroundColor:"transparent",zIndex:10}),t.hover(()=>t.css("color","#3b82f6"),()=>t.css("color","#64748b")),n.append(t),e+=parseInt(this.config.styles.button.size)+8}let i=r(`
                <button type="button" 
                    class="${this.config.buttonClass} ai-generate-btn" 
                    title="${this.config.i18n.generate}"
                    data-target-id="${a.attr("id")}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="${this.config.styles.button.iconSize}" height="${this.config.styles.button.iconSize}" fill="currentColor" class="bi bi-anthropic" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M9.218 2h2.402L16 12.987h-2.402zM4.379 2h2.512l4.38 10.987H8.82l-.895-2.308h-4.58l-.896 2.307H0L4.38 2.001zm2.755 6.64L5.635 4.777 4.137 8.64z"/>
                    </svg>
                </button>
            `);i.css({position:"absolute",bottom:"8px",right:e+"px",border:"none",borderRadius:"4px",width:this.config.styles.button.size,height:this.config.styles.button.size,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",padding:"0",color:"#64748b",transition:"all 0.2s ease",backgroundColor:"transparent",zIndex:10}),i.hover(()=>i.css("color","#3b82f6"),()=>i.css("color","#64748b")),n.append(i),this.instances.set(a.attr("id"),{$textarea:a,$btn:i,context:this.detectContext(a)})}},detectContext:function(t){t=t.closest('.modal, [role="dialog"]');return{isModal:0<t.length,$parentModal:t}},initSpeechRecognition:function(){var t=window.SpeechRecognition||window.webkitSpeechRecognition;t?(this.recognition=new t,this.recognition.continuous=!1,this.recognition.interimResults=!1,this.recognition.lang="en-US",this.recognition.onresult=t=>{var e,t=t.results[0][0].transcript,i=r(".ai-prompt-input:focus, textarea[data-ai-generate]:focus");i.length&&(e=i.val(),i.val(e+" "+t))},this.recognition.onerror=t=>{console.error("Speech recognition error",t.error),this.isListening=!1,this.updateVoiceButtonStates()},this.recognition.onend=()=>{this.isListening=!1,this.updateVoiceButtonStates()}):console.warn("Speech recognition not supported in this browser")},updateVoiceButtonStates:function(){r("."+this.config.buttonVoice).each(function(){var t=r(this);t.find("svg").replaceWith(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
                         viewBox="0 0 16 16">
                        ${e.isListening?'<path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"/>':'<path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"/><path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3"/>'}
                    </svg>
                `),t.css("color",e.isListening?"#ef4444":"#64748b")})},handleButtonClick:function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();t=r(t.currentTarget).data("target-id"),t=this.instances.get(t);t&&this.showModal(t)},handleVoiceButtonClick:function(t){if(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.recognition){t=r(t.currentTarget).data("target-id"),t=this.instances.get(t);if(this.isListening)this.recognition.stop(),this.isListening=!1;else try{this.recognition.start(),this.isListening=!0,t&&t.$textarea&&t.$textarea.focus()}catch(t){console.error("Speech recognition error:",t),this.isListening=!1}this.updateVoiceButtonStates()}else alert("Speech recognition not supported in your browser")},showSelectionNotice:function(t){let e=r('<div class="ai-selection-notice">Using selected text</div>');e.css({position:"absolute",top:"-25px",right:"0",background:"#3b82f6",color:"white",padding:"2px 8px","border-radius":"4px","font-size":"12px","z-index":10}),t.find(".ai-modal-header").append(e),setTimeout(()=>{e.fadeOut(500,()=>e.remove())},2e3)},convertToPlainText:function(t){var e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText||"".replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()},showModal:function(t){var{$textarea:t,context:e}=t,i=this.config.modalClass+"-"+t.attr("id"),a=this.getTextSelection(t[0]);let n=r("#"+i);0===n.length&&(n=this.createModal(i,t),r("body").append(n),this.setupModalEvents(n,t)),(e.isModal&&e.$parentModal.length?e.$parentModal:r("body")).append(n);i=this.calculateZIndex(e),n.css("z-index",i),n.find(".ai-modal-overlay").css("z-index",i),n.find(".ai-modal-content").css("z-index",i+10),n.data("target",t),e=t.attr("maxlength")||this.config.defaultMaxTokens;n.find("#ai-max-length").val(e),r("body").addClass("modal-open"),n.addClass(this.config.activeClass),this.prefillPrompt(t,n,a),n.find("#ai-prompt-input").trigger("focus"),this.config.closeOnOutsideClick?n.find(".ai-modal-overlay").css("pointer-events","auto"):n.find(".ai-modal-overlay").css("pointer-events","none")},getTextSelection:function(t){return{start:t.selectionStart,end:t.selectionEnd,text:t.value.substring(t.selectionStart,t.selectionEnd)}},prefillPrompt:function(t,e,i){let a="";i.start!==i.end&&0<i.text.trim().length?(a=i.text,this.showSelectionNotice(e)):a=t.val().trim(),a&&(i=this.convertToPlainText(a),t=e.find("#ai-prompt-input"),this.config.prefill.append?t.val(t.val()+" "+i):t.val(i))},calculateZIndex:function(t){let e=this.config.zIndexBase;return t.isModal&&t.$parentModal&&(t=parseInt(t.$parentModal.css("z-index"))||1050,e=t+10),Math.min(e,this.config.zIndexMax)},createModal:function(t,e){var i=this.config.i18n,a=this.config.styles.modal.maxWidth,n=this.config.styles.modal.width;return r(`
                <div id="${t}" class="${this.config.modalClass}">
                    <div class="ai-modal-overlay"></div>
                    <div class="ai-modal-content" style="max-width: ${a}; width: ${n}">
                        <div class="ai-modal-header">
                            <h3>${i.title}</h3>
                            <button class="ai-modal-close">&times;</button>
                        </div>
                        <div class="ai-modal-body">
                            <div class="ai-form-group">
                                <label for="ai-prompt-input">${i.promptLabel}</label>
                                <textarea id="ai-prompt-input" class="ai-prompt-input" 
                                    placeholder="${i.promptPlaceholder}" rows="3"></textarea>
                            </div>
                            
                            <div class="ai-options-grid">
                                <div class="ai-form-group">
                                    <label for="ai-max-length">${i.maxLengthLabel}</label>
                                    <input type="number" id="ai-max-length" class="ai-form-control"
                                        min="50" max="2000" value="${e.attr("maxlength")||this.config.defaultMaxTokens}">
                                </div>
                                <div class="ai-form-group">
                                    <label for="ai-creativity">${i.creativityLabel}</label>
                                    <select id="ai-creativity" class="ai-form-control">
                                        <option value="0.3">Low</option>
                                        <option value="0.7" selected>Medium</option>
                                        <option value="1.0">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="ai-response-error" style="display: none;"></div>
                            <div class="ai-result-section" style="display: none;">
                                <div class="ai-form-group">
                                    <label>${i.resultLabel}</label>
                                    <div class="ai-result-content"></div>
                                    <div class="ai-actions">
                                        <button class="ai-back-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16">
                                                <path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"/>
                                                <path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"/>
                                            </svg> ${i.back}
                                        </button>
                                        <button class="ai-insert-btn btn-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-circle" viewBox="0 0 16 16">
                                                <path d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0"/>
                                                <path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z"/>
                                            </svg> ${i.insert}
                                        </button>
                                        <button class="ai-regenerate-btn btn-secondary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                                <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41m-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9"/>
                                                <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5 5 0 0 0 8 3M3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9z"/>
                                            </svg> ${i.generate}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ai-loading-indicator" style="display: none;">
                                <div class="ai-spinner"></div>
                                <p>${i.loadingText}</p>
                            </div>
                        </div>
                        <div class="ai-modal-footer">
                            <button class="ai-generate-btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-anthropic" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M9.218 2h2.402L16 12.987h-2.402zM4.379 2h2.512l4.38 10.987H8.82l-.895-2.308h-4.58l-.896 2.307H0L4.38 2.001zm2.755 6.64L5.635 4.777 4.137 8.64z"/>
                                </svg>${i.generate}
                            </button>
                            <button class="ai-cancel-btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                </svg> ${i.cancel}
                            </button>
                        </div>
                    </div>
                </div>
            `)},setupModalEvents:function(e,i){let a=this;e.find(".ai-modal-close, .ai-cancel-btn").on("click",function(){e.removeClass(a.config.activeClass),e.find(".ai-modal-overlay").css("pointer-events",""),r("body").removeClass("modal-open")}),e.find(".ai-generate-btn").on("click",function(){a.generateContent(e)}),e.find(".ai-back-btn").on("click",function(){e.find(".ai-modal-body > *").show(),e.find(".ai-modal-footer").show(),e.find(".ai-loading-indicator").hide(),e.find(".ai-result-section").hide()}),e.find(".ai-insert-btn").on("click",function(){var t=e.find(".ai-result-content").text();i.val(t).trigger("input"),e.removeClass(a.config.activeClass),i.trigger("aiContentInserted",[t])}),e.find(".ai-regenerate-btn").on("click",function(){a.generateContent(e)}),e.find(".ai-result-content").on("click",function(){var t=r(this).text();i.val(t).trigger("input"),e.removeClass(a.config.activeClass),i.trigger("aiContentInserted",[t])}),e.on("keydown",function(t){"Escape"===t.key&&a.config.closeOnOutsideClick&&(e.removeClass(a.config.activeClass),e.find(".ai-modal-overlay").css("pointer-events",""),r("body").removeClass("modal-open"))})},generateContent:function(e){let i=e.data("target");var t=e.find("#ai-prompt-input").val().trim(),a=parseInt(e.find("#ai-max-length").val())||this.config.defaultMaxTokens,n=parseFloat(e.find("#ai-creativity").val())||.7;let o="text";o="html"===i.attr("data-ai-response")?"html":e.find("#ai-response").val()||"text",t?t.length<10?alert("Max length must be greater than 0"):1e3<t.length?alert("Max length must be less than 1000"):(e.find(".ai-modal-body > *").hide(),e.find(".ai-loading-indicator").show(),e.find(".ai-modal-footer").hide(),this.mockApiCall(t,a,o,n).then(t=>{"html"===o?e.find(".ai-result-content").html(t):e.find(".ai-result-content").text(t),e.find(".ai-loading-indicator").hide(),e.find(".ai-result-section").show(),e.find(".ai-response-error").hide(),i.trigger("aiContentGenerated",[t])}).catch(t=>{e.find(".ai-response-error").text(this.config.i18n.errorMessage+": "+t.message).show(),e.find(".ai-modal-body > *").show(),e.find(".ai-modal-footer").show(),e.find(".ai-loading-indicator").hide(),e.find(".ai-result-section").hide()})):alert("Please enter a prompt")},mockApiCall:function(t,a,n,o){return new Promise((e,i)=>{fetch(this.config.apiEndpoint,{method:this.config.apiMethod||"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",...this.config.apiHeaders||{}},body:JSON.stringify({prompt:t,maxLength:a,responseFormat:n,temperature:o})}).then(t=>{if(t.ok)return t.json();throw new Error(t.statusText)}).then(t=>{e(t)}).catch(t=>{i(t)})})},setupMutationObserver:function(){new MutationObserver(t=>{t.forEach(t=>{"childList"===t.type&&r(t.addedNodes).find("textarea[data-ai-generate]").each((t,e)=>{this.attachAIButton(r(e))})})}).observe(document.body,{childList:!0,subtree:!0})}};r.fn.aiDescriptionGenerator=function(t){return this.each(function(){var t=r(this);t.attr("data-ai-generate","true"),e.attachAIButton(t)})},r(document).ready(function(){e.init()}),window.AIGenerator=e})(jQuery);